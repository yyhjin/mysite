<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="board">
	
	<select id="findAll" resultType="boardvo" parameterType="map">
		<![CDATA[
		select b.no, b.title, b.contents, b.hit, date_format(b.reg_date, '%Y/%m/%d %H:%i:%s') as regDate, 
				b.g_no as groupNo, b.o_no as orderNo, b.depth, b.user_no as userNo, u.name as userName
		from board b, user u
		where b.user_no = u.no
		and b.title like '%${keyword}%'
		order by b.g_no desc, b.o_no asc
		limit #{page}, 5;
		]]>
	</select>
	
	<select id="findAllCount" resultType="int" parameterType="string">
		<![CDATA[
		select count(*)
		from board
		where title like '%${keyword}%'
		]]>
	</select>
	
	<select id="findByNo" resultType="boardvo" parameterType="long">
		<![CDATA[
		select title as title, contents as contents, 
			user_no as userNo, g_no as groupNo, o_no as orderNo, depth as depth
		from board
		where no = #{no}
		]]>
	</select>
	
	<update id="updateHit" parameterType="long">
		<![CDATA[
		update board
		set hit = hit+1
		where no = #{no}
		]]>
	</update>
	
	<delete id="deleteByNo" parameterType="long">
		<![CDATA[
		delete from board
		where no = #{no}
		]]>
	</delete>
	
	<select id="getMaxGroup" resultType="int">
		<![CDATA[
		select max(g_no)
		from board
		]]>
	</select>
	
	<update id="updateOrderNo" parameterType="map">
		<![CDATA[
		update board
		set o_no = o_no+1
		where g_no = #{groupNo}
		and o_no > #{orderNo}
		]]>
	</update>
	
	<insert id="insert" parameterType="boardvo">
		<![CDATA[
		insert into board(user_no, title, contents, g_no, o_no, depth, reg_date, hit)
		values(#{userNo}, #{title}, #{contents}, #{groupNo}, #{orderNo}, #{depth}, now(), 1)
		]]>
	</insert>
	
	<update id="updateBoard" parameterType="boardvo">
		<![CDATA[
		update board
		set title = #{title}, contents = #{contents}
		where no = #{no}
		]]>
	</update>
	
	<!-- 
	<select id="findByNo" resultType="uservo" parameterType="long">
		<![CDATA[
		select email, gender, name
		from user
		where no = #{no}
		]]>
	</select>
	
	<insert id="insert" parameterType="uservo">
		<![CDATA[
		insert into user
		values(null, #{name}, #{email}, password(#{password}), #{gender}, current_date())
		]]>
		<selectKey keyProperty="no" resultType="long" order="AFTER">	
			<![CDATA[
			select last_insert_id();
			]]>
		</selectKey>
	</insert>

	<update id="update" parameterType="uservo">
		<choose>
			<when test='password == ""'>
				<![CDATA[
				update user
				set name=#{name}, gender=#{gender}
				where no=#{no}
				]]>			
			</when>
			<otherwise>
				<![CDATA[
				update user
				set name=#{name}, password=password(#{password}), gender=#{gender}
				where no=#{no}
				]]>			
			</otherwise>
		</choose>
	</update>
	
	 -->
</mapper>
